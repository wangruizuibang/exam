<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>五个统一规范考试</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:15px;background:#f5f5f5}
h3{margin:8px 0 4px}
.qr-box{margin:15px 0;text-align:center}
.qr-box canvas{border:8px solid #fff;box-shadow:0 0 6px #ccc}
.card{background:#fff;margin:8px 0;padding:12px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.btn{background:#007bff;color:#fff;border:0;padding:8px 14px;border-radius:4px;margin:4px}
.btn:disabled{background:#aaa}
.result-green{color:green;font-weight:700}
.result-red{color:red;font-weight:700}
</style>
</head>
<body>

<div id="box">
  <h2>五个统一规范考试</h2>
  <div class="qr-box"><div id="qrcode"></div></div>
  <p align="center">扫码开始考试（25题，每题4分，满分100）</p>
</div>

<script>
/* ==========  配置  ========== */
const TOTAL_PER_TYPE = 5;          // 每类抽几题
const SCORE_PER_Q = 4;             // 每题分值
const EXCEL_NAME = '题库.xlsx';    // 同一目录下题库文件名
/* ============================ */

let bank=[], paper=[], answers={}, score=0;

/* 生成二维码（页面地址本身） */
new QRCode(document.getElementById("qrcode"),{
    text: location.href,
    width: 180,
    height: 180
});

/* 加载题库 */
function loadBank(){
  fetch(EXCEL_NAME)
    .then(r=>r.arrayBuffer())
    .then(ab=>{
        let wb=XLSX.read(ab,{type:'array'});
        wb.SheetNames.forEach((sn,idx)=>{
            let arr=XLSX.utils.sheet_to_json(wb.Sheets[sn],{header:['题','选','答','析'],defval:''});
            let pick=shuffle(arr).slice(0,TOTAL_PER_TYPE);
            pick.forEach(q=>q.type=sn);   // 记住类别
            bank=bank.concat(pick);
        });
        startExam();
    })
    .catch(err=>alert('题库加载失败：'+err));
}

/*  Fisher–Yates 洗牌  */
function shuffle(arr){
    let a=[...arr];
    for(let i=a.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
}

/* 开始考试 */
function startExam(){
    paper=shuffle(bank);   // 整体再打乱
    const box=document.getElementById('box');
    box.innerHTML='<h2>五个统一规范考试</h2>';
    paper.forEach((q,i)=>{
        const opts=q['选'].split(';').filter(Boolean);
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`<h3>第${i+1}题（${q.type}）</h3>
                        <p>${q['题']}</p>`+
                        opts.map((o,idx)=>`
                        <label><input type="radio" name="q${i}" value="${String.fromCharCode(65+idx)}"> ${o}</label><br>`).join('');
        box.appendChild(card);
    });
    box.innerHTML+=`<br><button class="btn" onclick="handIn()">交卷</button>`;
}

/* 交卷判分 */
function handIn(){
    let wrong=[];
    paper.forEach((q,i)=>{
        const sel=document.querySelector(`input[name="q${i}"]:checked`);
        const user=sel?sel.value:'';
        if(user===q['答']) score+=SCORE_PER_Q;
        else wrong.push({no:i+1,q:q['题'],right:q['答'],user,desc:q['析']});
    });
    showResult(wrong);
}

/* 显示分数与错题解析 */
function showResult(wrong){
    const box=document.getElementById('box');
    box.innerHTML=`<h2>考试结果</h2>
                   <p class="result-green">得分：${score} / 100</p>
                   <p>共 ${wrong.length} 题错误</p>`;
    if(wrong.length){
        wrong.forEach(w=>{
            box.innerHTML+=`<div class="card">
                              <b>第${w.no}题</b> 你的答案：${w.user||'未选'}，正确答案：${w.right}<br>
                              ${w.q}<br><span class="result-red">解析：${w.desc}</span>
                            </div>`;
        });
    }
    box.innerHTML+=`<br><button class="btn" onclick="location.reload()">再考一次</button>`;
}

/* 页面加载完成后自动拉题库 */
window.onload=loadBank;
</script>
</body>
</html>